{"name":"waylayAlarm","version":"0.0.5","type":"actuator","script":"var username =  options.globalSettings.API_KEY\nvar password = options.globalSettings.API_PASS\nvar severity = options.requiredProperties.severity || \"CRITICAL\"\nvar type = options.requiredProperties.type \nvar resource, text\n\ntry{\n    resource = waylayUtil.getRawData(options, options.requiredProperties.resource)\n} catch(err){\n    resource = options.requiredProperties.resource || waylayUtil.getResource(options)  \n}\nif(resource === '$')\n  resource = options.node.NAME\n\ntext = waylayUtil.template(options, options.requiredProperties.text)\n\n\nvar alarm = {\n    severity: severity,\n    type: type,\n    text: text,\n    source: {id: resource},\n    timestamp: moment().unix()\n}\n\nvar storeMessage = function(alarm){\n    var deferred = Q.defer()\n    console.log(\"storing alarm \" + JSON.stringify(alarm))\n    var url = \"https://alarms.waylay.io/alarm/alarms\";\n    var options = {\n        url: url,\n        json: alarm,\n        auth: {\n            user: username,\n            pass: password,\n            sendImmediately: true\n        }\n    };\n    request.post(options, function(error, response, body) {\n        if (error) {\n            console.log(\"alarm rejected \" + error)\n            return deferred.reject(error)\n        }\n        if (response.statusCode == 200) {\n            console.log(\"alarm stored \" + JSON.stringify(alarm));\n            deferred.resolve(response)\n        } else{\n            console.log(\"alarm rejected \" + JSON.stringify(body))\n            deferred.reject(new Error(JSON.stringify(body)))\n        }\n    });\n    return deferred.promise\n}\n\n\nif(resource === undefined || resource === \"\"){\n    send(new Error(\"resource not defined\"))\n} else {\n     storeMessage(alarm).then(function(){\n        console.log(\"DONE\")\n        send()\n    }).fail(function(err){\n        send(new Error(\"Storing alarm failed: \" + err))\n    });\n}\n\n\n\n\n","metadata":{"author":"","category":"Waylay","description":"Uses waylay alarms interface to store alarms.\n\n","documentationURL":"","iconURL":"https://s3.eu-central-1.amazonaws.com/static.waylay.io/plugs/icons/alarm.png","supportedStates":[],"requiredProperties":["resource","text","severity","type"],"requiredRawData":[]}}