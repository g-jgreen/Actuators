{
  "name": "lifxActuator",
  "version": "0.0.3",
  "type": "actuator",
  "script": "var props = options.requiredProperties;\n\nvar clientId = options.globalSettings.DASHBOARD_KEY;\nvar clientSecret = options.globalSettings.DASHBOARD_SECRET;\nvar dashboardDomain = options.globalSettings.DASHBOARD_DOMAIN;\n\nvar selector = props.selector;\nvar tokenFromCache = waylayUtil.getCacheData(options, \"token\");\nvar power = props.power || \"on\";\nvar brightness = props.brightness || 1.0; //this is dangerous if br = 0\nvar duration = props.duration || 5;\nvar color = props.color || \"red\";\nvar profile = props.profile || waylayUtil.getResource(options);\nvar json = {\n            power: power,\n            color: color,\n            brightness: brightness,\n            duration: duration\n        };\nconsole.log(json);\n\nvar getToken = function(callback){\n  var options = {\n      url: \"https://\"+dashboardDomain+\"/api/token/lifx/\" + profile,\n       auth: {\n        user: clientId,\n        password: clientSecret\n      }\n  };\n  \n  try {\n      request(options, function(error, response, body) {\n      if (!error && response.statusCode == 200) {\n          var bodyJson = JSON.parse(body);\n          console.info(bodyJson);\n          callback(null, bodyJson);\n      }else{\n          callback(new Error(\"Calling lifx api failed: \" + error + \" \" + body + options.url));\n      }\n    });\n  } catch(err){\n       callback(new Error(\"Calling lifx api failed: \" + err));\n  }\n}\n\n\nvar setState = function(token) {\n    var url = \"https://api.lifx.com/v1/lights/\" + selector +\"/state\";\n    request.put(url, {\n        auth: {\n            'bearer': token\n        },\n        json: json\n    }, function(err, response, body) {\n       if (!err && response.statusCode == 207) {\n            console.log(body)\n            send();\n       } else{\n           console.log(response)\n           send(new Error(response.statusCode));\n       }\n    });\n};\n  \nvar setDeviceData = function(token){\n  console.log(token);\n  if(token.accessToken !== undefined){\n    setState(token.accessToken);\n  } else{\n    send(new Error(\"Token for profile \"+ profile + \" not valid\"));  \n    }\n}\n\nif(clientId !== undefined && clientSecret !== undefined && dashboardDomain !== undefined && selector !== undefined){\n  getToken(function(err, token){\n    if(err){\n      //send(err);\n      //try with the old token\n      if(tokenFromCache !== undefined){\n          console.log(\"try with an old token, since the request to the dashboard failed\");\n          setDeviceData({accessToken: tokenFromCache});\n      }else {\n          console.log(err.stack)\n          send(new Error(err));\n      }\n    }else{\n      setDeviceData(token);\n    }\n  });\n}else{\n    send(new Error(\"Missing properties\"));\n}\n",
  "metadata": {
    "author": "",
    "category": "Experimental",
    "description": "Lifx actuator\nyou can change the color, turn the lamp on or off, or change the brightness\n\nInput arguments are:\n<ul>\n<li>selector</li>\n<li>power : on or off</li>\n<li>color : you can also defined saturation level, like \"blue saturation:0.5\"</li>\n<li>brightness : number between 0 and 1</li>\n<li>duration : duration in seconds (in case that the power is on)</li>\n</ul>",
    "documentationURL": "http://api.developer.lifx.com/docs/set-state",
    "iconURL": "https://static.waylay.io/plugs/icons/lifx.png",
    "supportedStates": [],
    "requiredProperties": [
      "power",
      "color",
      "brightness",
      "duration",
      "selector",
      "profile"
    ],
    "requiredRawData": []
  }
}
